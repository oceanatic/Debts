<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Debts</title>
  <style>
    :root { --bg:#0b0f17; --card:#121a26; --muted:#93a4b8; --text:#e6edf7; --line:#233043; }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{ margin:0; background:linear-gradient(120deg,#0b0f17,#0a1322); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ margin:0 0 8px; font-size:28px; }
    .sub{ color:var(--muted); margin:0 0 18px; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 420px 1fr; align-items:start; } }
    .card{ background:rgba(18,26,38,.92); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, select, button, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0f1724;
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{ border-color:#3a5c89; }
    .row{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .btn{
      cursor:pointer;
      border:none;
      background:linear-gradient(135deg,#2f6fed,#2cc7a8);
      padding:11px 12px;
      font-weight:700;
      margin-top:12px;
    }
    .btn.secondary{ background:#0f1724; border:1px solid var(--line); font-weight:600; }
    .btn.danger{ background:linear-gradient(135deg,#ff4d6d,#ff9f43); }
    .inline{ display:flex; gap:10px; flex-wrap:wrap; }
    .inline > *{ flex:1 1 160px; }
    .stats{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .stat{ border:1px solid var(--line); border-radius:14px; padding:12px; background:#0f1724; }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ font-size:18px; font-weight:800; margin-top:6px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--line); }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      background:#0f1724;
      padding:10px;
      border-bottom:1px solid var(--line);
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid rgba(35,48,67,.6);
      vertical-align:top;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#0f1724;
      color:var(--muted);
    }
    .actions{ display:flex; gap:8px; }
    .actions button{ width:auto; padding:8px 10px; border-radius:10px; }
    .small{ font-size:12px; color:var(--muted); }
    .muted{ color:var(--muted); }
    .nowrap{ white-space:nowrap; }
    .log{
      max-height:240px; overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0f1724;
      padding:10px;
    }
    .logitem{ padding:8px; border-bottom:1px solid rgba(35,48,67,.6); }
    .logitem:last-child{ border-bottom:none; }
    .logitem b{ color:var(--text); }

    /* Views */
    .hidden{ display:none !important; }
    .center{
      min-height: calc(100vh - 48px);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .menuCard{ max-width:520px; width:100%; }
    .menuBtns{ display:grid; gap:10px; grid-template-columns: 1fr; }
    @media(min-width:560px){ .menuBtns{ grid-template-columns: 1fr 1fr; } }

    /* Viewer breakdown row */
    .breakRow td { padding: 0; }
    .breakBox{
      padding:12px;
      background:#0f1724;
      border-top:1px solid rgba(35,48,67,.6);
    }
    .portion{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      padding:8px 10px;
      border:1px solid rgba(35,48,67,.8);
      border-radius:12px;
      margin:8px 0;
      background:#0b1320;
    }
    .portion .left{ flex:1 1 auto; }
    .portion .amt{ flex:0 0 auto; font-weight:800; }

    .banner{
      border:1px solid var(--line);
      background:#0f1724;
      border-radius:14px;
      padding:10px 12px;
      margin-bottom:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .banner b{ color:var(--text); }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HOME VIEW -->
    <div id="homeView" class="center">
      <div class="card menuCard">
        <h1>Debts</h1>
        <p class="sub">Choose a mode</p>
        <div class="menuBtns">
          <button class="btn" id="goViewBtn">View Debts</button>
          <button class="btn secondary" id="goAdminBtn">Admin Panel</button>
        </div>
        <p class="small" style="margin-top:12px;">
          You're probably here to view debts, so click it already
        </p>
      </div>
    </div>

    <!-- ADMIN LOGIN VIEW -->
    <div id="adminLoginView" class="center hidden">
      <div class="card menuCard">
        <h1>Admin Panel</h1>
        <p class="sub">Enter password to continue</p>
        <label>Password</label>
        <input id="adminPass" type="password" placeholder="Password" />
        <button class="btn" id="adminLoginBtn">Enter</button>
        <button class="btn secondary" id="backFromLoginBtn">Back</button>
        <p class="small muted" id="adminLoginMsg" style="margin-top:10px;"></p>
      </div>
    </div>

    <!-- VIEW DEBTS VIEW -->
    <div id="viewDebtsView" class="hidden">
      <div class="inline" style="align-items:end; margin-bottom:12px;">
        <div style="flex:2 1 260px;">
          <h1 style="margin:0;">How much do you owe me?</h1>
          <p class="sub" style="margin:6px 0 0;">Probably a lot...</p>
        </div>
        <div style="flex:1 1 160px;">
          <button class="btn secondary" id="backFromViewBtn" style="margin-top:0;">Back</button>
        </div>
      </div>

      <div class="banner">
        <span id="connStatus" class="pill" style="margin-left:8px;">Connecting…</span>
      </div>

      <div class="card">
        <div class="inline" style="align-items:end;">
          <div style="flex:2 1 260px;">
            <label>Search</label>
            <input id="viewSearch" placeholder="Search..." />
          </div>
          <div style="flex:1 1 180px;">
            <label>Sort</label>
            <select id="viewSort">
              <option value="balanceDesc">Balance (high → low)</option>
              <option value="balanceAsc">Balance (low → high)</option>
              <option value="nameAsc">Name (A → Z)</option>
              <option value="nameDesc">Name (Z → A)</option>
            </select>
          </div>
        </div>

        <div class="stats" style="margin-top:12px;">
          <div class="stat">
            <div class="k">Total Debt</div>
            <div class="v" id="viewTotal">$0</div>
          </div>
          <div class="stat">
            <div class="k">People With Debts</div>
            <div class="v" id="viewCount">0</div>
          </div>
        </div>

        <div style="margin-top:12px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:30%;">Person</th>
                <th style="width:20%;">Debt</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="viewTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ADMIN PANEL VIEW -->
    <div id="adminPanelView" class="hidden">
      <div class="inline" style="align-items:end; margin-bottom:12px;">
        <div style="flex:2 1 260px;">
          <h1 style="margin:0;">Admin Panel</h1>
          <p class="sub" style="margin:6px 0 0;">Time to make some money</p>
        </div>
        <div style="flex:1 1 160px;">
          <button class="btn secondary" id="backFromAdminBtn" style="margin-top:0;">Back</button>
        </div>
      </div>

      <div class="banner">
        <div class="small muted" id="adminFirebaseMsg" style="margin-top:6px;"></div>
      </div>

      <div class="grid">
        <!-- LEFT: Forms -->
        <div class="card">
          <h2 style="margin:0 0 10px; font-size:18px;">Add Debt Portion</h2>

          <label>Person</label>
          <input id="person" placeholder="Name" />

          <div class="row">
            <div>
              <label>Amount</label>
              <input id="amount" type="number" step="1" min="0" inputmode="numeric" placeholder="Amount" />
            </div>
            <div>
              <label>Due Date (optional)</label>
              <input id="due" type="date" />
            </div>
          </div>

          <label>Portion Note (optional)</label>
          <input id="note" placeholder="Note for this portion" />

          <button class="btn" id="addBtn">Add Portion</button>
          <button class="btn secondary" id="clearFormBtn">Clear Form</button>

          <hr style="border:none; border-top:1px solid var(--line); margin:16px 0;">

          <h2 style="margin:0 0 10px; font-size:18px;">Log a Payment (Specific Portion)</h2>

          <label>Person</label>
          <select id="payPerson"></select>

          <label>Debt Portion</label>
          <select id="payPortion"></select>

          <div class="row">
            <div>
              <label>Payment Amount</label>
              <input id="payAmount" type="number" step="1" min="0" inputmode="numeric" placeholder="Amount" />
            </div>
            <div>
              <label>Payment Date</label>
              <input id="payDate" type="date" />
            </div>
          </div>

          <label>Payment Note (optional)</label>
          <input id="payNote" placeholder="Note" />

          <button class="btn" id="payBtn">Apply Payment</button>

          <hr style="border:none; border-top:1px solid var(--line); margin:16px 0;">

          <div class="inline">
            <button class="btn secondary" id="exportBtn">Export JSON</button>
            <button class="btn secondary" id="importBtn">Import JSON</button>
            <button class="btn danger" id="wipeBtn">Wipe All Data</button>
          </div>
          <p class="small" style="margin-top:10px;"></p>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>

        <!-- RIGHT: Table + stats -->
        <div class="card">
          <div class="inline" style="align-items:end;">
            <div style="flex:2 1 260px;">
              <label>Search</label>
              <input id="search" placeholder="Search by name or note…" />
            </div>
            <div>
              <label>Sort</label>
              <select id="sort">
                <option value="balanceDesc">Balance (high → low)</option>
                <option value="balanceAsc">Balance (low → high)</option>
                <option value="nameAsc">Name (A → Z)</option>
                <option value="nameDesc">Name (Z → A)</option>
                <option value="dueAsc">Due date (soonest)</option>
                <option value="dueDesc">Due date (latest)</option>
              </select>
            </div>
          </div>

          <div class="stats" style="margin-top:12px;">
            <div class="stat">
              <div class="k">Total Owed To You</div>
              <div class="v" id="totalOwed">$0</div>
            </div>
            <div class="stat">
              <div class="k">People With Debts</div>
              <div class="v" id="peopleCount">0</div>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:22%;">Person</th>
                  <th style="width:16%;">Balance</th>
                  <th style="width:16%;">Due</th>
                  <th>Breakdown</th>
                  <th style="width:18%;">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <h2 style="margin:16px 0 10px; font-size:18px;">Recent Activity</h2>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase (ES Modules) -->
  <script type="module">
    // =============================
    // KEEP THIS PASSWORD EXACTLY
    // =============================
    const ADMIN_PASSWORD = "Jj8808520@";

    // =============================
    // DISCORD WEBHOOK (posts to #Daily Reminder)
    // =============================
    const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1451822540686102639/9poM5O-vV2p7YwVKJr4Njj_ZS9a1jnqosMCgJbF4jWc-0DqO4DmrqgERTpA13LibQxNP";

    // =============================
    // YOU MUST FILL THESE IN
    // =============================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCrWTZUeuLgU-i4h7eDpkdiKI8UqsfR6o0",
      authDomain: "debts-7c53d.firebaseapp.com",
      projectId: "debts-7c53d",
      storageBucket: "debts-7c53d.firebasestorage.app",
      messagingSenderId: "922613772542",
      appId: "1:922613772542:web:02d7dfbc2216dad2ea75af"
    };

    // Your Firebase Auth admin credentials (email/password provider)
    // This is NOT your UI password above — this is your Firebase account login.
    const ADMIN_EMAIL = "jasonyou8808@gmail.com";
    const ADMIN_FIREBASE_PASSWORD = "Jj8808520@";

    // Where data lives in Firestore:
    // collection: state, doc: main
    const DOC_PATH = { collection: "state", doc: "main" };

    // =============================
    // Firebase Imports
    // =============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, doc, onSnapshot, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    // =============================
    // App State (v2 portions)
    // =============================
    let state = { people:{}, log:[] };
    let unsub = null;
    let isAdminSession = false;
    let writeLock = false;

    // Helpers
    const el = (id) => document.getElementById(id);

    function show(id){
      ["homeView","adminLoginView","viewDebtsView","adminPanelView"].forEach(v => el(v).classList.add("hidden"));
      el(id).classList.remove("hidden");
    }

    // NO CENTS
    function money(n){
      const v = Math.round(Number(n || 0));
      const abs = Math.abs(v).toLocaleString(undefined, { maximumFractionDigits: 0 });
      return (v < 0 ? "-$" : "$") + abs;
    }

    function normName(name){ return (name || "").trim(); }
    function keyFor(name){ return normName(name).toLowerCase(); }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function uuid(){
      return (crypto?.randomUUID ? crypto.randomUUID() : ("p_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
    }
    function totalBalance(person){
      const portions = Array.isArray(person.portions) ? person.portions : [];
      return portions.reduce((s,pt)=> s + Math.round(Number(pt.amount)||0), 0);
    }

    async function postDiscord(content){
      if(!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL.startsWith("PASTE_")) return;
    
      try{
        // Discord webhooks accept multipart with payload_json
        const fd = new FormData();
        fd.append("payload_json", JSON.stringify({ content }));
    
        // no-cors: request is sent; response is opaque (you can't read it)
        await fetch(DISCORD_WEBHOOK_URL, {
          method: "POST",
          mode: "no-cors",
          body: fd
        });
    
      } catch(e){
        console.error("Discord webhook failed:", e);
      }
    }


    function mentionForPerson(personRecord, fallbackName){
      const id = personRecord && personRecord.discordUserId;
      if(id && String(id).trim()) return `<@${String(id).trim()}>`;
      return (personRecord && personRecord.name) ? personRecord.name : (fallbackName || "Someone");
    }

    async function notifyBalanceChange(personKey, oldBal, newBal, personRecord){
      const nameFallback = (personRecord && personRecord.name) ? personRecord.name : personKey;
      const who = mentionForPerson(personRecord, nameFallback);

      // Debt increase
      if(newBal > oldBal){
        const delta = newBal - oldBal;
        if(oldBal > 0){
          await postDiscord(`${who} Another ${money(delta)} huh? Don't get too carried away now. Your debt is now ${money(newBal)}.`);
        } else {
          await postDiscord(`${who} Welcome back, loyal patron! Your debt is now ${money(newBal)}!`);
        }
        return;
      }

      // Payment (decrease)
      if(newBal < oldBal){
        const paid = oldBal - newBal;

        if(newBal === 0){
          // Fully paid off
          await postDiscord(`${who} You have paid ${money(oldBal)} out of ${money(oldBal)}. You're a free man for now.`);
        } else {
          // Partial payment
          await postDiscord(`${who} You have paid ${money(paid)} out of ${money(oldBal)}. Just another ${money(newBal)} to go.`);
        }
      }
    }

    async function notifyDiffs(oldPeople, newPeople){
      const keys = new Set([
        ...Object.keys(oldPeople || {}),
        ...Object.keys(newPeople || {})
      ]);

      for(const k of keys){
        const oldRec = (oldPeople || {})[k];
        const newRec = (newPeople || {})[k];

        // If record disappeared (e.g., import removed it), skip to avoid weird spam.
        if(!newRec) continue;

        const oldBal = oldRec ? totalBalance(oldRec) : 0;
        const newBal = newRec ? totalBalance(newRec) : 0;

        if(oldBal === newBal) continue;
        await notifyBalanceChange(k, oldBal, newBal, newRec);
      }
    }

    function pushLog(entry){
      state.log = Array.isArray(state.log) ? state.log : [];
      state.log.unshift(entry);
      state.log = state.log.slice(0, 60);
    }
    function migrateShapeToV2(incoming){
      const s = incoming && typeof incoming === "object" ? incoming : { people:{}, log:[] };
      if(!s.people) s.people = {};
      if(!s.log) s.log = [];

      const anyKey = Object.keys(s.people)[0];
      if(anyKey && s.people[anyKey] && Array.isArray(s.people[anyKey].portions)) {
        for(const k of Object.keys(s.people)){
          const p = s.people[k];
          p.portions = (p.portions || []).map(pt => ({
            id: pt.id || uuid(),
            amount: Math.round(Number(pt.amount||0)),
            note: (pt.note || "").trim(),
            createdAt: pt.createdAt || Date.now()
          }));
        }
        return s;
      }

      // v1 -> v2
      const newPeople = {};
      for(const k of Object.keys(s.people || {})){
        const p = s.people[k];
        const bal = Math.round(Number(p.balance || 0));
        const n = p.name || k;
        const due = p.due || "";
        const note = p.note || "";

        const portions = [];
        if(bal > 0 || note){
          portions.push({ id: uuid(), amount: bal, note: (note||"").trim(), createdAt: Date.now() });
        }
        newPeople[k] = { name:n, due: due, portions: portions, updatedAt: p.updatedAt || Date.now() };
      }
      s.people = newPeople;
      delete s._needsMigration;
      return s;
    }

    function setConn(text){
      const c = el("connStatus");
      if(c) c.textContent = text;
    }

    // =============================
    // Firebase Init
    // =============================
    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const stateRef = doc(db, DOC_PATH.collection, DOC_PATH.doc);
    console.log("DOC_PATH =", DOC_PATH);
    console.log("Firestore doc path =", stateRef.path);

    // Live read for everyone
    function startListener(){
      if(unsub) unsub();

      setConn("Connecting…");
      unsub = onSnapshot(stateRef, (snap) => {
        if(snap.exists()){
          const data = migrateShapeToV2(snap.data());
          // Avoid clobbering UI mid-write in same tab
          if(!writeLock){
            state = data;
            renderAdmin();
            renderView();
          }
          setConn("Live");
        } else {
          // If doc doesn't exist yet, treat as empty
          state = { people:{}, log:[] };
          renderAdmin();
          renderView();
          setConn("Empty");
        }
      }, (err) => {
        console.error(err);
        setConn("Offline");
      });
    }

    async function ensureDocExists(){
      const snap = await getDoc(stateRef);
      if(!snap.exists()){
        await setDoc(stateRef, { people:{}, log:[], updatedAt: Date.now() }, { merge: false });
      }
    }

    // Writes only from admin session
    async function saveRemote(){
      if(!isAdminSession){
        alert("Not admin session. You can't write.");
        return;
      }
      // Prevent rapid double-writes
      if(writeLock) return;
      writeLock = true;
      try{
        const out = {
          people: state.people || {},
          log: state.log || [],
          updatedAt: Date.now()
        };
        await setDoc(stateRef, out, { merge: false });
      } catch(e){
        console.error(e);
        alert("Firebase write failed (rules/auth). Check console + Firestore rules.");
      } finally{
        writeLock = false;
      }
    }

    // Track auth state (optional display/debug)
    onAuthStateChanged(auth, (user) => {
      const msg = el("adminFirebaseMsg");
      if(!msg) return;
      if(user){
      } else {
        msg.textContent = "Not signed into Firebase.";
      }
    });

    // =============================
    // Navigation wiring
    // =============================
    el("goViewBtn").addEventListener("click", () => { show("viewDebtsView"); renderView(); });
    el("goAdminBtn").addEventListener("click", () => { show("adminLoginView"); el("adminPass").focus(); });

    el("backFromLoginBtn").addEventListener("click", () => { el("adminPass").value=""; el("adminLoginMsg").textContent=""; show("homeView"); });
    el("backFromViewBtn").addEventListener("click", () => { show("homeView"); });
    el("backFromAdminBtn").addEventListener("click", () => { show("homeView"); });

    el("adminLoginBtn").addEventListener("click", tryAdminLogin);
    el("adminPass").addEventListener("keydown", (e) => { if(e.key === "Enter") tryAdminLogin(); });

    async function tryAdminLogin(){
      const pass = el("adminPass").value;
      if(pass !== ADMIN_PASSWORD){
        el("adminLoginMsg").textContent = "Wrong password.";
        return;
      }

      // UI password ok — now sign into Firebase (real security is Firestore rules)
      try{
        el("adminLoginMsg").textContent = "Signing into Firebase…";

        if(ADMIN_EMAIL.startsWith("PASTE_") || ADMIN_FIREBASE_PASSWORD.startsWith("PASTE_")){
          el("adminLoginMsg").textContent = "You didn't set ADMIN_EMAIL / ADMIN_FIREBASE_PASSWORD in the code yet.";
          return;
        }

        await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_FIREBASE_PASSWORD);
        isAdminSession = true;

        el("adminPass").value = "";
        el("adminLoginMsg").textContent = "";
        show("adminPanelView");
        renderAdmin();
        renderView();
      } catch(e){
        console.error(e);
        el("adminLoginMsg").textContent = "Firebase login failed. (Wrong email/pass OR auth not enabled.)";
      }
    }

    // =============================
    // ADMIN elements
    // =============================
    const person = el("person");
    const amount = el("amount");
    const due = el("due");
    const note = el("note");
    const addBtn = el("addBtn");
    const clearFormBtn = el("clearFormBtn");

    const payPerson = el("payPerson");
    const payPortion = el("payPortion");
    const payAmount = el("payAmount");
    const payDate = el("payDate");
    const payNote = el("payNote");
    const payBtn = el("payBtn");

    const search = el("search");
    const sort = el("sort");
    const tbody = el("tbody");
    const totalOwed = el("totalOwed");
    const peopleCount = el("peopleCount");
    const logBox = el("log");

    const exportBtn = el("exportBtn");
    const importBtn = el("importBtn");
    const importFile = el("importFile");
    const wipeBtn = el("wipeBtn");

    payDate.valueAsDate = new Date();

    addBtn.addEventListener("click", async () => {
      // Snapshot old balance before mutation
      const n = normName(person.value);
      const k = keyFor(n);
      const oldBal = (k && state.people && state.people[k]) ? totalBalance(state.people[k]) : 0;

      addPortion(person.value, amount.value, due.value, note.value);

      const newBal = (k && state.people && state.people[k]) ? totalBalance(state.people[k]) : 0;

      await saveRemote();

      // Notify based on change
      if(k && newBal !== oldBal){
        await notifyBalanceChange(k, oldBal, newBal, state.people[k]);
      }
    });

    clearFormBtn.addEventListener("click", clearAddForm);

    payBtn.addEventListener("click", async () => {
      const k = payPerson.value;
      if(!k || !state.people || !state.people[k]) return alert("Pick a person.");

      const oldBal = totalBalance(state.people[k]);

      applyPaymentSpecific(payPerson.value, payPortion.value, payAmount.value, payDate.value, payNote.value);

      const newBal = (state.people && state.people[k]) ? totalBalance(state.people[k]) : 0;

      await saveRemote();

      if(newBal !== oldBal){
        await notifyBalanceChange(k, oldBal, newBal, state.people[k]);
      }
    });

    payPerson.addEventListener("change", () => populatePortionsForPayment(payPerson.value));

    search.addEventListener("input", renderAdmin);
    sort.addEventListener("change", renderAdmin);

    tbody.addEventListener("click", async (evt) => {
      const btn = evt.target.closest("button");
      if(!btn) return;
      const act = btn.getAttribute("data-act");
      const k = btn.getAttribute("data-k");
      if(act === "edit"){ editPerson(k); await saveRemote(); }
      if(act === "delete"){ deletePerson(k); await saveRemote(); }
    });

    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify({ people: state.people||{}, log: state.log||[] }, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "debts-export.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", () => importFile.click());
    importFile.addEventListener("change", async () => {
      const file = importFile.files?.[0];
      if(!file) return;

      // Snapshot state BEFORE import so we can diff if user pushes
      const beforePeople = JSON.parse(JSON.stringify(state.people || {}));

      try{
        const txt = await file.text();
        const incoming = migrateShapeToV2(JSON.parse(txt));
        state = incoming;
        renderAdmin();
        renderView();

        if(confirm("Imported into this session. Push to Firebase now?")){
          await saveRemote();

          // Diff notifications (multiple messages)
          const afterPeople = state.people || {};
          await notifyDiffs(beforePeople, afterPeople);
        }
      }catch(e){
        alert("Import failed. Make sure it's valid JSON.");
      }finally{
        importFile.value = "";
      }
    });

    wipeBtn.addEventListener("click", async () => {
      if(!confirm("Wipe ALL Firebase data? This affects everyone.")) return;
      state = { people:{}, log:[] };
      renderAdmin();
      renderView();
      await saveRemote();

      await postDiscord("The monarchy has been overthrown, everybody is now debt-free!");
    });

    function ensurePersonRecord(name, dueDate){
      const n = normName(name);
      const k = keyFor(n);
      if(!state.people) state.people = {};
      if(!state.people[k]){
        state.people[k] = { name:n, due:"", portions:[], updatedAt: Date.now() };
      }
      if(!Array.isArray(state.people[k].portions)) state.people[k].portions = [];
      if(dueDate) state.people[k].due = dueDate;
      state.people[k].updatedAt = Date.now();
      return k;
    }

    function addPortion(name, amt, dueDate, noteText){
      const n = normName(name);
      if(!n) return alert("Enter a person's name.");
      const a = Math.round(Number(amt));
      if(!(a > 0)) return alert("Amount must be greater than 0.");

      const k = ensurePersonRecord(n, dueDate);

      state.people[k].portions.push({
        id: uuid(),
        amount: a,
        note: (noteText || "").trim(),
        createdAt: Date.now()
      });

      pushLog({ ts: Date.now(), type:"add", name:n, amount:a, note: (noteText || "") });

      renderAdmin();
      renderView();
      clearAddForm();
    }

    function applyPaymentSpecific(personKey, portionId, amt, dateStr, noteText){
      const k = personKey;
      if(!k || !state.people || !state.people[k]) return alert("Pick a person.");
      const a = Math.round(Number(amt));
      if(!(a > 0)) return alert("Payment must be greater than 0.");
      if(!portionId) return alert("Pick a portion.");

      const p = state.people[k];
      const pt = (p.portions || []).find(x => x.id === portionId);
      if(!pt) return alert("That portion no longer exists.");

      pt.amount = Math.round(Number(pt.amount || 0) - a);
      if(pt.amount < 0) pt.amount = 0;
      p.updatedAt = Date.now();

      const dateNote = dateStr ? ` (${dateStr})` : "";
      const portionLabel = pt.note ? ` [${pt.note}]` : " [portion]";
      pushLog({
        ts: Date.now(),
        type:"pay",
        name: p.name,
        amount: a,
        note: (noteText || "") + portionLabel + dateNote
      });

      p.portions = (p.portions || []).filter(x => Number(x.amount || 0) > 0);

      renderAdmin();
      renderView();

      payAmount.value = "";
      payNote.value = "";
      populatePortionsForPayment(payPerson.value);
    }

    function editPerson(k){
      const p = state.people[k];
      const newName = prompt("Edit name:", p.name);
      if(newName === null) return;

      const trimmed = normName(newName);
      if(!trimmed) return alert("Name can't be blank.");

      const newKey = keyFor(trimmed);
      const newDue = prompt("Edit due date (YYYY-MM-DD) or blank:", p.due || "");
      if(newDue === null) return;

      if(newKey !== k){
        if(state.people[newKey]) return alert("That name already exists.");
        delete state.people[k];
        state.people[newKey] = { ...p, name: trimmed, due: (newDue||"").trim(), updatedAt: Date.now() };
      }else{
        p.name = trimmed;
        p.due = (newDue||"").trim();
        p.updatedAt = Date.now();
      }

      pushLog({ ts: Date.now(), type:"edit", name: trimmed, amount: 0, note: "Edited person" });
      renderAdmin();
      renderView();
    }

    function deletePerson(k){
      const p = state.people[k];
      if(!confirm(`Delete ${p.name}? This removes their debt portions.`)) return;
      delete state.people[k];
      pushLog({ ts: Date.now(), type:"delete", name: p.name, amount: 0, note: "Deleted person" });
      renderAdmin();
      renderView();
    }

    function clearAddForm(){
      person.value = "";
      amount.value = "";
      due.value = "";
      note.value = "";
    }

    function renderAdmin(){
      renderPaySelect();
      renderAdminTable();
      renderAdminStats();
      renderLog();
      populatePortionsForPayment(payPerson.value);
    }

    function renderPaySelect(){
      const keys = Object.keys(state.people || {});
      const entries = keys
        .map(k => ({ k, ...state.people[k], balance: totalBalance(state.people[k]) }))
        .filter(p => p.balance > 0)
        .sort((a,b) => a.name.localeCompare(b.name));

      payPerson.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = entries.length ? "Select person…" : "No balances";
      payPerson.appendChild(opt0);

      for(const p of entries){
        const opt = document.createElement("option");
        opt.value = p.k;
        opt.textContent = `${p.name} — ${money(p.balance)}`;
        payPerson.appendChild(opt);
      }
    }

    function populatePortionsForPayment(personKey){
      payPortion.innerHTML = "";
      const k = personKey;
      if(!k || !state.people || !state.people[k]){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Select person first…";
        payPortion.appendChild(opt);
        return;
      }

      const p = state.people[k];
      const live = (p.portions || []).filter(pt => Number(pt.amount||0) > 0);

      if(!live.length){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No portions with balance";
        payPortion.appendChild(opt);
        return;
      }

      for(const pt of live){
        const opt = document.createElement("option");
        opt.value = pt.id;
        const label = (pt.note || "").trim() ? pt.note.trim() : "—";
        opt.textContent = `${money(pt.amount)} — ${label}`;
        payPortion.appendChild(opt);
      }
    }

    function getFilteredSortedPeopleAdmin(){
      const q = (search.value || "").trim().toLowerCase();

      let arr = Object.keys(state.people || {}).map(k => {
        const p = state.people[k];
        const portionsText = (p.portions || []).map(pt => pt.note || "").join(" ").toLowerCase();
        return { k, ...p, balance: totalBalance(p), _portionsText: portionsText };
      });

      if(q){
        arr = arr.filter(p =>
          p.name.toLowerCase().includes(q) ||
          (p._portionsText || "").includes(q)
        );
      }

      const s = sort.value;
      arr.sort((a,b) => {
        if(s === "balanceDesc") return b.balance - a.balance;
        if(s === "balanceAsc") return a.balance - b.balance;
        if(s === "nameAsc") return a.name.localeCompare(b.name);
        if(s === "nameDesc") return b.name.localeCompare(a.name);
        if(s === "dueAsc") return (a.due || "9999-12-31").localeCompare(b.due || "9999-12-31");
        if(s === "dueDesc") return (b.due || "0000-01-01").localeCompare(a.due || "0000-01-01");
        return 0;
      });

      return arr;
    }

    function renderAdminTable(){
      const arr = getFilteredSortedPeopleAdmin();

      tbody.innerHTML = "";
      if(arr.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="muted">No entries yet. Add someone on the left.</td>`;
        tbody.appendChild(tr);
        return;
      }

      for(const p of arr){
        const breakdown = (p.portions || [])
          .filter(pt => Number(pt.amount || 0) > 0)
          .map(pt => `${money(pt.amount)} — ${escapeHtml((pt.note || "").trim() || "—")}`)
          .join("<br>");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${escapeHtml(p.name)}</b><div class="small muted">${escapeHtml(p.k)}</div></td>
          <td class="nowrap"><span class="pill">${money(p.balance)}</span></td>
          <td class="nowrap">${p.due ? escapeHtml(p.due) : `<span class="muted">—</span>`}</td>
          <td>${breakdown || `<span class="muted">—</span>`}</td>
          <td>
            <div class="actions">
              <button class="btn secondary" data-act="edit" data-k="${escapeHtml(p.k)}">Edit</button>
              <button class="btn danger" data-act="delete" data-k="${escapeHtml(p.k)}">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderAdminStats(){
      const arr = Object.values(state.people || {});
      const totalAmt = arr.reduce((sum,p)=> sum + totalBalance(p), 0);
      const countAmt = arr.filter(p => totalBalance(p) > 0).length;
      el("totalOwed").textContent = money(totalAmt);
      el("peopleCount").textContent = String(countAmt);
    }

    function renderLog(){
      logBox.innerHTML = "";
      if(!state.log || !state.log.length){
        logBox.innerHTML = `<div class="muted small">No activity yet.</div>`;
        return;
      }
      for(const e of state.log){
        const when = new Date(e.ts).toLocaleString();
        const label =
          e.type === "add" ? "Added debt" :
          e.type === "pay" ? "Payment" :
          e.type === "edit" ? "Edited" :
          e.type === "delete" ? "Deleted" : e.type;

        const amt = e.amount ? ` • <b>${money(e.amount)}</b>` : "";
        const noteTxt = e.note ? ` • <span class="muted">${escapeHtml(e.note)}</span>` : "";

        const div = document.createElement("div");
        div.className = "logitem";
        div.innerHTML = `<b>${label}</b> — ${escapeHtml(e.name)}${amt}${noteTxt}<div class="small muted">${when}</div>`;
        logBox.appendChild(div);
      }
    }

    // VIEW MODE
    const viewSearch = el("viewSearch");
    const viewSort = el("viewSort");
    const viewTbody = el("viewTbody");
    const viewTotal = el("viewTotal");
    const viewCount = el("viewCount");

    viewSearch.addEventListener("input", renderView);
    viewSort.addEventListener("change", renderView);

    viewTbody.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-act='toggle']");
      if(!btn) return;

      const k = btn.getAttribute("data-k");
      const tr = btn.closest("tr");
      const next = tr.nextElementSibling;

      if(next && next.classList.contains("breakRow")){
        next.remove();
        btn.textContent = "Click for breakdown";
        return;
      }

      const p = (state.people || {})[k];
      if(!p) return;

      const portions = (p.portions || []).filter(pt => Number(pt.amount||0) > 0);
      const lines = portions.length ? portions.map(pt => `
        <div class="portion">
          <div class="left">
            <div><b>${escapeHtml((pt.note || "").trim() || "—")}</b></div>
          </div>
          <div class="amt">${money(pt.amount)}</div>
        </div>
      `).join("") : `<div class="muted small">No portions (everything paid or none added).</div>`;

      const html = `
        <tr class="breakRow">
          <td colspan="3">
            <div class="breakBox">
              <div class="small muted">Breakdown for <b>${escapeHtml(p.name)}</b></div>
              ${lines}
            </div>
          </td>
        </tr>
      `;
      tr.insertAdjacentHTML("afterend", html);
      btn.textContent = "Hide breakdown";
    });

    function renderView(){
      const q = (viewSearch.value || "").trim().toLowerCase();

      let arr = Object.keys(state.people || {}).map(k => {
        const p = state.people[k];
        return { k, ...p, balance: totalBalance(p) };
      });

      arr = arr.filter(p => Number(p.balance || 0) > 0);

      if(q){
        arr = arr.filter(p => p.name.toLowerCase().includes(q));
      }

      const s = viewSort.value;
      arr.sort((a,b) => {
        if(s === "balanceDesc") return b.balance - a.balance;
        if(s === "balanceAsc") return a.balance - b.balance;
        if(s === "nameAsc") return a.name.localeCompare(b.name);
        if(s === "nameDesc") return b.name.localeCompare(a.name);
        return 0;
      });

      const totalAmt = arr.reduce((sum,p)=> sum + (Number(p.balance)||0), 0);
      viewTotal.textContent = money(totalAmt);
      viewCount.textContent = String(arr.length);

      viewTbody.innerHTML = "";
      if(arr.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" class="muted">No balances to show.</td>`;
        viewTbody.appendChild(tr);
        return;
      }

      for(const p of arr){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${escapeHtml(p.name)}</b></td>
          <td class="nowrap"><span class="pill">${money(p.balance)}</span></td>
          <td>
            <button class="btn secondary" data-act="toggle" data-k="${escapeHtml(p.k)}" style="margin-top:0;">Click for breakdown</button>
          </td>
        `;
        viewTbody.appendChild(tr);
      }
    }

    // Boot
    (async () => {
      try{
        await ensureDocExists();
      } catch(e){
        console.error(e);
        // If rules require auth for creation, this might fail on first load.
        // In that case, create the doc once from admin account in Firebase console or after admin login.
      }
      startListener();
      show("homeView");
      renderAdmin();
      renderView();
    })();
  </script>
</body>
</html>

